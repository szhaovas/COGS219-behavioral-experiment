<!DOCTYPE html>
<html>
  <head>
    <script src="jspsych.js"></script>
    <script src="plugins/jspsych-html-keyboard-response.js"></script>
    <script src="plugins/jspsych-reconstruction.js"></script>
    <link rel="stylesheet" href="css/jspsych.css"></link>
  </head>
  <body></body>
  <script>

  /*change log
  1. Add satuation as an attribute of filename and read from it to generate satuation of the matching block
  2. dim and bright_value should be relative to the original hue of the facial image, also make sure it's RANDOM
  (?)3. fixation cross
  4. practice trial
  */

  // If you want to add more pictures to the stimuli pool, please be sure to add
  // them in .jpg form in the folder /img/
  // Also make sure to name them in the template
  // "img/[frown/smile]~[light/medium/dark]~[hue]~[facial ID]~[brightness].jpg"
  // and add the name to the directory array
  const directory = ['img/frown~dark~22~0~51.jpg', 'img/frown~light~17~0~88.8.jpg', 'img/frown~medium~26~0~67.6.jpg', 'img/smile~dark~22~0~51.jpg', 'img/smile~light~17~0~88.8', 'img/smile~medium~26~0~67.6'];
  const facial_expressions = ['frown', 'smile'];
  const skin_tone_categories = ['light', 'medium', 'dark'];
  const satuation = 50;
  const dim_value = 0.25;
  const bright_value = 0.75;
  const num_hues = 3;
  const num_faces_each_hue = 2;
  const num_images = num_hues * num_faces_each_hue;

  // randomly selects a facial expression and a skin tone
  // all images in this run will have the selected facial expression and skin tone
  const this_facial_expression = facial_expressions[Math.floor(Math.random() * facial_expressions.length)];
  const this_skinTone = skin_tone_categories[Math.floor(Math.random() * skin_tone_categories.length)];

  // randomly selects [num_hues] hues
  const hue_matcher = new RegExp(this_facial_expression + '~' +  this_skinTone);
  const hue_pool = (function() {
    let result = [];
    directory.forEach(filename => {
      hue_matcher.test(filename) && result.push(parseInt(filename.split('~')[2]));
    });
    return result;
  }());
  const hues = jsPsych.randomization.sampleWithoutReplacement(hue_pool, num_hues);

  // randomly select [num_faces_each_hue] faces for each hue selected in the previous step
  // and create the images array containing the images that will be used in this run
  const images = (function() {
    let result = [];
    for (let h = 0; h < num_hues; h++) {
      let face_matcher = new RegExp(this_facial_expression + '~' +  this_skinTone + '~' + hues[h]);
      let shuffled_directory = jsPsych.randomization.repeat(directory, 1);
      for (let counter = 0, i = 0; (counter < num_faces_each_hue) && (i < shuffled_directory.length); i++) {
        let filename = shuffled_directory[i];
        if (face_matcher.test(filename)) {
           result.push(filename);
           counter++;
         }
      }
    }
    return result;
  }());

  // These lines make sure each image is shown in 1 of the 2 starting colors, either starting dim or starting bright
  const full_design = (function() {
    let result = [];
    let shuffled_images = jsPsych.randomization.repeat(images, 1);
    let starting_colors = jsPsych.randomization.repeat([dim_value, bright_value], (num_images / 2));
    for (let i = 0; i < num_images; i++) {
      let obj = {
        stimulus: shuffled_images.pop(),
        starting_value: starting_colors.pop()
      }
      result.push(obj);
    };
    return result;
  }());

  // This is the reconstruction function
  // It reads the RGB values of the image used for 1 trial (from the file names, which is why they must include RGB values)
  // and use those to construct the color selection square to be displayed below the image
  // By pressing either F or J, participants are only allowed to modify to "Red value" of the color selection square
  var test = function(param, stim){
    let h = stim.split('~')[2];
    let b = param * 100;
    let html = '<div style="height: 50%"><img src="'+stim+'" width="250" height="250"></div>'+
      '<div style="display: block; margin: auto; height: 300px; width: 300px; position: relative;">'+
      '<div style="display: block; position: absolute; top: 62.5px; left: 62.5px; background-color: hsl('+h+','+satuation+'%,'+b+'%); '+
      'width: 175px; height: 175px;"></div></div><p>Press F to make the square darker. Press J to make the square brighter.</p>'+
      '<p>When the square is the same color as the picture, click Next.</p>';
    return html;
  }

  var test = {
    timeline: [{
      type: 'reconstruction',
      stimulus: jsPsych.timelineVariable('stimulus'),
      stim_function: test,
      starting_value: jsPsych.timelineVariable('starting_value'),
      step_size: 0.05,
      key_increase: 'j',
      key_decrease: 'f',
      button_label: 'Next',
      on_finish: function(data){
        // starting_color can be either "bright start" or "dim start"
        // difference is the difference between stimulus image's and the final color match square's brightnesses
        data.starting_color = (this.starting_value == bright_value) ? 'bright start' : 'dim start';
        data.difference = data.final_value * 100 - parseFloat(this.stimulus.slice(0, -4).split('~')[4]);
      }
    }],
    timeline_variables: full_design
  };

  // For each participant, add a random ID and the facial expression used in his/her experiment run
  var subject_id = jsPsych.randomization.randomID(2);
  jsPsych.data.addProperties({
    subject: subject_id,
    facial_expressions: this_facial_expression,
    skinTone: this_skinTone
  });

  jsPsych.init({
    timeline: [test],
    preload_images: images,
    show_preload_progress_bar: false,
    on_finish: function() { jsPsych.data.displayData(); }
  });

  </script>
</html>
